# WIFI-Pentesting-Notes

# Basics:

## Wi-Fi
wireless Fidelity (wi-fi). It is based on IEEE 802.11 standard and it operate on either 2.4GHz or 5 GHz ISM radio bands.

## Access point (AP)
It is a central node in 802.11 wireless implementation. It is the interface between wired and wireless network

## Base Transceiver Station (BTS)
It is equivalent of an AP from 802.11 world and it provides signal coverage like 3G, GSM etc.. 

## Wireless Controller (WLC)
In corporate wireless Implementation, the number of AP is too many, so it is better to have an one central node connected to all the AP's to manage them all at once. Here comes WLC to play :)

## Service Set Identifier (SSID)
-> SSID identifies the wirelss WLAN itself.  
-> To connect to wireless LAN, client needs to send the same exact SSID in the association frame as the SSID name, preconfigure on the AP. 
-> Wireless cards detects the SSID's in the near
-> How can the wireless card differ between many networks ? In one of the fields in a beacon frame contains the SSID name always in clear text (Many AP send 10-20 beacon frames every second)
-> SSID can have up to 32 characters.
-> If AP has multiple SSID's defined, AP will send a seperate beacon frame for each SSID

## Cell
It is a geographical region covered by the AP's or BTS's antenna

## Channel
In an area with multiple AP's, the smart channel assignment is used to avoid collisions
(Collisions happened, wenn frames transmitted on the **same frequency** and at the **same time** from multiple sources)

## Antennas
Like a USB-stick antenna. It used to translate information ....
It is very useful, because it can be configured in "monitor mode". It allows to sniff traffic from your PC using **wireshark** or **kismet**

# Wireless Network Categories
-> Wireless Personal Area Network (WPAN): 
**Coverage:** Max 10 meters
**Example:** Bluetooth, 802.15
**Application:** Data Exchange between phones, headset, smartwatch

-> Wireless Local Area Network (WLAN): 
**Coverage:** Apartments, work place
**Example:** 802.11 Wi-Fi
**Application:** Enterprise, Markets, Airport, Home

-> Wireless Metropolitan Area Network (WMAN): 
**Coverage:** All around the city
**Example:** wimax, IEEE 802.16
**Application:** between homes and businesses 

-> Wireless Wide Area Network (WWAN): 
**Coverage:** Through the world
**Example:** 3G, LTE
**Application:** access to the internet from any device 


## 802.11 Standards Currently
Standard -> Frequency -> Max speed
802.11 -> 2.4 GHz -> 2 Mbps
802.11a -> 5 GHz -> 54 Mbps
802.11b -> 2.4 GHz -> 11 Mbps
802.11g -> 2.4 GHz -> 54 Mbps
802.11n -> 2.4 or 5 GHz -> 600 Mbps
802.11ac -> 5 GHz -> 1 Gbps

-> But why we do not see high speed, wenn we download data over Wi-Fi?
There is a difference between the speed and the actual throughout. Since wireless communication is half-duplex (single antenna either recieve or transmit), the actual throughout is around 50% of the speed. ??????

-> The 802.11ac are not widely supported on end-devices. 

-> How to check your Wi-Fi Network standards?
1. By sniffing for the wireless beacon frames, because every beacon frame contains the list of speeds that are supported by transmitting AP
2. By using some tools for network discovery like **inSSIDer on MAC** or **Airdump-ng on linux** or **Network Stumbler on Windows**
You can see what Max Rate/speed they support and see if it is 802.11a/b/g/n/ac

## Wi-Fi Authentication Modes
possible authentication schemes that are used in the wireless deployments:
**Open Authentication** 
and 
**Pre-Shared Key (PSK)-based authentication** 

## Open Authentication
Open Authentication allows any one to connect to the network without any security checks
It process like below:
1. Client -> Authentication Request -> Authenticator
2. Client <- Authentication Response <- Authenticator
3. Client -> Association Request -> Authenticator
4. Client <- Association Response <- Authenticator

In words: 
1. client says: I want to authenticate 
2. Authenticator response: Yes, here you go 

## EAP-based 4-way handshake (with WPA/WPA2)
A client connects to an AP through 4-way handshake. During those messages exchange, the shared key is derived between AP and client, without being transmitted in any of those EAP messages
Process like below: 
Client has: 1.**PMK is known**		2.**Generates SNonce**
Authenticator has: 1.**PMK is known**		2.**Generates ANonce**
1. Client <- **Message 1:** EAPOL-Key(ANonce, Unicast) <- Authenticator 
2. Client -> **Message 2:** EAPOL-Key(SNonce, Unicast,MIC) -> Authenticator 
3. Client <- **Message 3:** EAPOL-Key(Install PTK, Unicast, MIC, encrypted GTK) <- Authenticator 
4. Client -> **Message 4:** EAPOL-Key(Unicast, MIC) -> Authenticator#

The Pairwise master key (PMK) is interest to the hacker, to break the network encryption scheme. PMK is know only to Authenticator and client and not shared anywhere in the transit. 
However, the session keys are combined of ANonce, SNonce, PMK, MAC of Authenticator and client. 
In Mathematical formula:
**Session_keys = f(ANonce, SNonce, PMK, Authenicator_MAC,Client_MAC)**
So to get the PMK we either:
1. break the AES/RC4
or 
2. the only practical approach is to brute-force the PMK

## Wi-Fi Chalking
It is some marks that describe either the Wi-Fi is open/closed/WEP
)( -> Open Node
() -> Closed Node
(W) -> WEP Node

## Encryption
Transform data to ciphertext
-> There is no fully secure encryption scheme, all algorithms can be broken
## There is 2 type of encryption algorithms: 
1.**Stream Cipher**: It converts plaintext into ciphertext in a bit by bit 
2.**Block Cipher**: It operates on the fixed-size blocks of data
## Common encryption algorithms:
Encryption algorithm-> Type of encryption algorithms -> Size of data block 
RC4	   				   	  	   -> Stream Cipher    ->             --- 
RC5                    	   	 -> Block Cipher    ->                32,64,128 bits 
DES                    	   	  -> Block Cipher		-> 			56 bits
3DES				      -> Block Cipher		-> 		   56 bits
AES 			    	 	 -> Block Cipher		-> 			128bits

-> In wireless network mostly use **RC4** and **AES** encryption algorithm

## WEP vs. WPA vs. WPA2
Pre-shared Key = PSK

-> WEP			
**Encryption Alogrithm:** WEP(based on RC4)		
**Authentication Methods:** PSK 						
**breaking encryption:** IV collision attack / weak key attack / reinjection attack / bit flipping attack

-> WPA			
**Encryption Alogrithm:** TKIP(based on RC4)	     
**Authentication Methods:** PSK or 802.1x		  
**breaking encryption:** Cracking captured password from 4-ways-handshake

-> WPA2
**Encryption Alogrithm:** CCMP(based on AES)	 
**Authentication Methods:** PSK or 802.1x		  
**breaking encryption:** Cracking captured password from 4-ways-handshake

**WEP**: It based on RC4 algorithm and 24 bits of Initialization Vector (IV) - weak encryption algorithm
**WPA2**: It invented with strong encryption model (AES) and very strong authentication model based on PSK or 802.1x  + **WPA**: Alot of wireless card did not support the AES, so they were using RC4+TKIP, so therefore WPA was based on that mechanism.

## Weak Initialization Vectors (IV)
In WEP, there is to inputs of IV to the algorithm, one is 24 bits and added to the ciphertext in a clear text and the another is a WEP key 
?????????

The vulnerability is only presented in WEP. WPA uses TKIP that solved weak IV by increasing its size from 24 to 48 bits 

# Break the encryption of WEP and WPA
## WEP
There are many tools to break the WEP encryption, but all of them follow this 3 steps:
1. select a target network
2. collect (sniff) WEP encryption packets flying over the air. Tools for that "airodump-ng"
3. when enough packets are collected (collected set of frames with IV duplicate), we try to crack the network with "aircrack-ng" tools

## WPA
Wireless frames, that uses WPA, are using TKIP encryption that still using the concept of IV and RC4. The IV here is 48 bits long. however it modified to be more secure. 
TKIP modifies WEP with the Following:
1. It uses temporal, dynamically created keys in WPA instead of static keys in WEP
2. It uses sequencing to defend against replay and injection attacks
3. It uses advanced key mixing algorithm to defeat IV collision and weak key attack in WEP
4. It introduces Enhanced Data Integrity (EDI) to defeat bit-flipping attack in WEP

The above points make WPA more secure and not-possible to crack only by brute-forcing. WPA uses 802.1x (EAP-based authentication) for authentication the client, so this is the only weak point to break the WPA/WPA2, so how ? 

WPA/WPA2 standards supports 2 type of authentication : 
**Pre-shared Key (PSK)** and **802.1x** based on external authentication server.
-> If **802.1x** is used, so it is not possible to break the WPA/WPA2 - All the enterprise network wireles use 802.1x based on external RADIUS server.
-> If **PSK** is used, you may have some chances... - used by small businesses on home networks. The PSK must be short in size (PSK up to 10 character, where the max is 64 character).
The PSK is only once transmitted, during the 4-ways-handshake between client and AP, so you need to sniff (capture) those 4 packets and bruteforce them using a good dictionary
site to calculate the brute-force time: http://lastbit.com/pswcalc.asp 

The Process of breaking a WPA/WPA2 encryption (only when they use PSK algorithm):
1. select a target network
2. collect (sniff) wireless packets flying over the air. Tools for sniffing wireless packets "airodump-ng"
3. while packets are collected, you should de-authenticate the current clients, so that they can authenticate again and do the 4-ways-handshake. Here hacker is sniffing everything, so he is sniffing 4-ways-handshake packets. Tools to de-authenticate current client from the network is "aireplay-ng" 
4. Now hacker has the sniffed/captured 4-ways-handshake, save it as a file and pass the file to "aircrack-ng" to crack it with a good dictionary.

-> The Above attacks will be shown in details later.....


## How to defend against WPA crack?
1. Use WPA2 instead of WPA, because AES (used by WPA2) is much more safer then TKIP (used by WPA)
2. we saw that breaking WPA/WPA2 is possible by capturing the 4-ways-handshake and brute-force, so used a password of at least 10 characters (contains digits, special character, upper/lowercase etc...)
3. Disable Wi-Fi Protected Setup (WPS)

# Attacks Types

## Access Control Attacks
It is about controlling, who have access to the network, und who does not. The idea of access control is similar to Authentication Process. Authentication Process is most often based on username+password and access control goes beyond that like client's device etc..

Its mechanism based on MAC address whitelisting. AP has a list of authorized MAC address. It is not very secure, since the MAC address can be simply spoofed by sniffing the traffic in the air with tools like wireshark and find the whitelisted MAC addresses.
router control pannel -> wireless -> MAC filter

Example: wireshark (there is much more advanced techniques)
We open it, we get many packet, we filter them to get only data packats (not beacon frames or other mangment frames) **(wlan.fc.subtype == 0x28) && (wlan.addr == $AP_MAC)**
After we find out the whitelisted MAC addresses, we set them locally on our machine
```
> ifconfig wlan0 down
> macchanger --mac=WHITELISTED_MAC wlan0
> ifconfig wlan0 up
> ifconfig wlan0
```

some advanced whitelisting is based on MAC address, device vendor etc...

## Integrity attacks
Integrity -> data has not tampered/changed between A and B. 
802.11 can be overheard by 3rd party on the same frequency channel. 

EXAMPLE:
1. client ask a friend to send him 1000€ to his bank account. the bank details are in the e-mail.
2. we assume the information is not well encrypted or encryption can be broken, so the attacker can sniff the message in the air, then attacker modifies it (put his bank details) and re-inject the message back in the air. In this case if there is no **integrity checks** that can detect the changes on the message, the friend will get the message with the attacker bank details. This is hard to implement in real life, because e-mails application like mail exchange are secured against such attacks (via proper encryption and message integrity checks)

So there is 2 security-measures against this type of integrity attacks
1. Encryption (so attacker will be able to read the message)
2. Message Integrity Codes MIC's (so attacker will be able to change/tempered the message). It is basically hashing function that take a footprint of the whole message and create a hash of 128 bits (MD5) or 160 btis (SHA1), so if attacker change the content the hash value will be changed and the message will be denied (already implemented in routers)

## Confidentiality attacks
Attacks here are targeted to break the encryption model used in wireless deployment.
-> **No encryption / WEP encryption:** Not very secure approaches and should not be used
-> **TKIP Encryption:** Used in WPA deployments. Not cracked yet but it has uses a weak RC4 algorithm
-> **CCMP Encryption:** Used with WPA2. Considered the safest encryption model and based oon not-breakable (at least until now) AES algorithm.

The main goal of this kind of attacks is to break the encryption and get a value of the key.

## DOS attacks
DOS Attacks on avialability can be divided into 3 types:
- Layer 1 DOS
- Layer 2 DOS 
- Layer 3 DOS

## Layer 1 DOS
## Queensland Attack
It used to disrupt operation of the 802.11 WLAN. It is basically sending out a constant RF signal, so other client can't get access to the medium, because the wireless medium is occupied by the constant transmitter.

Jamming tools are used to force the client to re-authenticate and hacker will capture the 4-ways-handshake to offline bruteforce the key and can help to do MITM attacks

Creating a layer 1 jammer with tools like websploit is easy. steps:
1. use "airodump-ng" to collect information about the target WLAN (BSSID, channel etc..)
2. to perform the jamming attack, we need BSSID+Channel as an input to Websploit
3. run websploit
```
wsf> show module
# we will use Wi-Fi/wifi_jammer under wireless modules
wsf> use Wi-Fi/wifi_jammer
wsf> show options
# After setting all the required infos
wsf> run
```
The result of this attacks is, that all devices will be disconnected and they can't connect back until the attack is stopped!!!

## Layer 2 DOS
The main idea of this attack is to temper the 802.11 wireless frames and inject/retransmit them in the air.
Common attacks in layer 2 involve of disassociation or de-authentication mangement frames.

Authentication process is a pre-requisite for association, a de-authentication frame will automatically disassociate the client as well, so for this we will use the "aireplay-ng" tool. steps:
1. check connected clients with "airodump-ng" tools
2. to perform the de-authentication DOS attack , we need ...
3. run aireplay
```
> aireplay-ng --deauth 1 -a $AP_MAC -e $AP_NAME -c $SPECIFIC_TARGET_MAC $INTERFACE_CARD
```
The result again, the specific chosen target is disconnected for the wifi

**Mitigation:** To use 802.11w-2009 standard management frame protection (MFP). This standard ensure that management frames (like disassociation or de-authentication frames) are signed by a trusted AP, if they should be neglected if they are from malicious client or fake AP 

## Layer 3 DOS
The idea of this attack is to send large volumn of traffic to crash the host.

The 3 most common type of layer 3 attacks are: 

## Fraggle Attack
Attacker sends a large amount of UDP echo requests to IP broadcast address. The source IP address is spoofed and is set to a victim IP address. By doing that, all the replies originated on by the clients on the broadcast subnet are sent back to the victim

## Ping Flood Attack
Attacker sends a large number of ICMP packet to the target computer using ping
(mostly using botnets)

## Smurf Attack
These type of layer 3 attacks are not specifically for wireless technology. they can be used over any layer 2 technology, either ethernet, frame rely, ATM or wireless. It is effective, if attacks has a botnet with more then 100 devices or even more then 1000 devices.

## Authentication Attacks

we already cleared senario based on EAP-authentication used in WPA/WPA2, with PSK authentication.

LEAP (Lightweight Extensible Authentication Protocol). It was used in old times as a mechanism to generate WEP keys. Here the password hashes were send over the air with MS-CHAP or MS-CHAPv2 alogrithms (both are crack-able with an offline dictionary attack)
Discription to authentication attacks, may be applied to LEAP would consist the following steps:
1. Username is sent in clear text
2. Challenge text is sent in clear text
3. Response text is hashed
4. Bruteforce attack inside "fucntion(password, challenge) = response" methematical formula, to find the right password.

## Rogue Access Point Attacks
A rogue access device (AP) is any WLAN radio that connected to the corporate network (most often to some network switch) without the authorization.
A rogue AP looks like the router at home or a Raspberry PI (Most often placed at the back of the rack hidden between hundreds of network cables)

-> Risks may be identified:
1. Data theft - corporate data may be compromised
2. Data Destruction - Database may be erased 
3. Loss of Services - Network services can be disabled
4. Malicious Data insertion - Upload viruses, key loggers, pornography
5. 3rd party attacks - ex: attacks against networks over the internet in the name/ip of the corporate

## Client Misassociation
You experienced, that your device are automatically connected to the Wi-Fi. This happened, because your device has a list of WLAN's (It called "Preferred Network List" in windows), that were connected to before. 
In this case, hacker can create a network with the same target network name (like airport, caffee etc..), if the signal from the hacker is better then the original AP signal, then the victim will be automatically connected to the hacker AP. It is easy to perform (with airbase-ng tool) and know also as "Honeypot AP attacks"

Example:
let's assume that victime device was connected to an airport WLAN named "airport-Guest", so the victim's machine remember the SSID on the PNL (Preferred Network List), so I will create this SSID using "airbase-ng"
```
airbase-ng -e $Target_SSID -c 6 -P $INTERFACE_NAME
airbase-ng -e airport-Guest -c 6 -P wlan0
```
then we used Layer 2 DOS attack to de-authentication the victim from any network he is already connected to, so that the victim machine can detect my created SSID and connect to it automatically.
After the victim connect to my SSID, I can do some additional attacks like MITM attack or exploiting the machine itself with metasploit and so on

## Misconfiguration Access Point Attack
It can be found at home or in small businesses, not in large businesses, because they mosly are using centralized platforms that controls hundreds of AP and keep them synchronized.  

Common areas of misconfiguraiton lead to wireless cracking:
1. default credentials (username, password) or default WLAN's broadcasted (SSID's) or default settings
2. Human error - weak security settings

## Ad-Hoc Connection Attack
It is like device-1 is connected to the AP/modem directly, then device-1 create a virtual software AP, so that other devices will connect to device-1 not to the real AP/modem. 
in Linux -> "airbase-ng" 
in windows -> WLAN can be created in a wireless network settings using "configure new connection on new network"

Here attacker can connect to device-1 and route the traffice to him

# Wireless Hacking Methodology
## Wi-Fi discovery
Wi-Fi discovery is not against the law. 
Tools on windows -> **Xirrus Wi-Fi Inspector** or **NetStumbler**
Tools on Linux -> **Airodump-ng** or **Kismet**
 
## Wardriving
It is a process of finding a wireless network by a person in a car using their personal laptop, phone or any tools. The intention is to find free Wi-Fi, that malicious user can use without any legal obligation.

## GPS Mapping
wigle.net is a website to see WLAN's are GPS mapped.

# Traffic Analysis
Traffic analysis is very helpful in forensic investigation or during troubleshooting. It is a great way for self-study, where you can see how devices are communicating with each other.
First you need to sniff the traffice (by kismet or wireshark etc..)

The valuable data for the penetester are **BSSID**, **WEP IV**, **TKIP IV**, **CCMP IV**, **EAP 4-way handshake**, **wireless beacon frames**, **MAC addresses** etc..
we will use these data as an input to our tools to break the Wi-Fi network

# Launch Wireless Attacks
Passive vs. Active
-> Examples of  Passive attacks
### Breaking WEP encryption 
1. sniff a large amount of data packets
2. get the same IV vector inside the wireless frames
3. break the WEP encryption offline
As we see there is no single steps, that requires the attacker to communicate with the victim

### Breaking WPA/WPA2 encryption
1. sniff EAP 4-way handshake 
2. bruteforce on the collected encrypted data to break the encryption

but sometime, if the user is already authenticated, we need to send frames to de-authenticate him from the network, so he can do 4-way handshake and attacker can sniff it :)

### sniffing packets between 2 devices
Assuming that we break the encryption between the 2 devices or they used unencrypted protocol.

-> Example of Active attacks
### Injection of wireless traffic
A classic example of Layer 2 Dos, used by flooding of de-authentication frames. Here the attacker is directly injecting the packets that affect the client (telling him to de-authenticate!).

### Jamming Attacks
A classic example of Layer 1 Dos attacks. Jamming devices are used to create interferences with a valid RF of Wi-Fi network, which will lead the network service to degradate. Here attacker is directly affecting the wireless behavior :)

### MITM Attack
Here attacker can do like the following:
Attacker has a machine with 2 network cards. one is connected to the read AP and the other is broadcasting a fake AP, so that other clients/victims connect to the fake AP, where attacker can intercept/change/modifies/read data :)

**In summary:**
Passive is about 80% of the whole attack process, where attacker collect much information about the target and its enviroment. The rest 20% is Active, where attacker start using this collected information to start attacking then network itself. 

# Crack Wireless Attacks
Cracking the encryption, authentication or hash algorithm to get some secrets passwords.

-> If the encryption algorithm is weak, it may be breakable. crypto analyst knowledge will bring you forwards
-> Most attacks here concentrate on brute-force attacks

aircrack-ng is specifically used to crack WEP/WPA/WPA2
```
> aircrack-ng kismet-packets-captured.pcapdump -w dictionary.txt
```

# Radio Frequency Monitoring Tools:

# Radio Frequemcy (RF) Monitoring Tools 

examples: microwaves oven, wireless camera
(search on google to learn more about RF)

## Cisco Spectrum Expert
Used for RF monitoring. Cisco Spectrum Expert combined with Cisco AP. Some Cisco's AP's have a feature called "clean air", which allow the AP to be used as RF monitor!

We connect "Cisco Spectrum Expert" device to the AP

Note: Bluetooth operation is based on the "Frequency Hopping Spread Spectrum" (FHSS) technology, it implies that Bluetooth device will jump from one frequency to another (around 1600 hops per second) 

## AirSleuth Spectrum Analyzer
It is a combination of 802.11 Network discovery tools and 2.4 GHz spectrum analysis (Cisco clear-air AP's supports both bands 2.4GHz and 5GHz)

# Bluetooth Hacking
Bluetooth wireless communication technology (IEEE 802.15.1), that works over limited distance (around 10-30m). It works on the same frequency range as the 2.4GHz WLAN (from 2.4GHz to 2.485GHz), therefor using the bluetooth communication in tha same area would interfere with WLAN networks.

To use Bluetooth you need a card that is compactible for 802.15 technology. The Wi-Fi card (802.11) is not compatible with Bluetooth based on 802.15 standard.

## Security Models
- **Security Model 1 - Unprotected:** In this mode, no encryption or authentication is used.
- **Security Model 2 - Application/Service Based:** In this mode, once connection is established, a Security Manager perform authentication, thereby restricting access to the device
- **Security Model 3 - Link-Layer PIN authentication/MAC address Encryption:** Authentication is performing before the connection is established. even the using of encryption, the device will still compromised

# Bluetooth Stack
In Wi-Fi communication (based on 802.11 Protocol), all OSI layers are involved in the communication. With Bluetooth protocol stack is a bit difference as devices do not all the OSI layers, because Bluetooth was developed to be used by a variety of communication application

## Bluetooth Protocols Layers:
- **Bluetooth Core Protocol Baseband:** LMP, L2CAP, SDP
- **Cable Replacement Protocol:** RFCOMM
- **Telephony Control Protocol:** TCS Binary, AT-Commands
- **Adopted Protocols:** PPP, UDP/TCP/IP, WAP

Additional element on the stack **Host Controller Interface (HCI)**. It provide a command interface to the baseband controller, link manager, hardware status, registers. Bluetooth linux tools are starting from "hci"; ex: "hciconfig", "hcidump", "hcitool"


# Bluetooth Threats
**Remember:** Each Technology has its unique threats and vulnerabilities.

##### Bad coding during development of RFCOMM stack implementation
-> may lead to buffer overflow
-> no patches release

##### Re-use of older services for different protocols
-> Some highly privileged services are left open

##### IrMC Permissions
-> IrMC defines a set of permissions for common bluetooth objects
-> Permissions, which are not monitoring or just open, may lead to exploit the service

With the above mentioned vulnerabilities of weakness, attacker can:
-> Steal information
-> Dos on end-device
-> RCE
-> Inject viruses or worms
-> Inject crafted connection to go via bluetooth device (working as proxy)

# Bluetooth Hacking Tools
There is tuns of tools
## hciconfig
It used to interact with Bluetooth device (Bluetooth dongle). 
Similar to **ifconfig**, **iwconfig**

## hcitool
It used to interact with the bluetooth stack.
Most common options are **scan**, **inq**
hcitool will scan for bluetooth devices, that are send out their discovery beacons (something like 802.11 beacon frames sent out by AP)
```
# to look for bluetooth enabled devices, that inform about their readiness to accept Bluetooth connections.
> hcitool scan

# To find more bluetooth informtaion
> hcitool inq
```

## sdptool
It used to perform Service Discovery (SDP). It enumerates all the services running on the bluetooth device.
```
> sdptool browse $TARGET_MAC
```

## l2ping
Similar to ping utility from the IP world.
to check if a device is reachable or not
```
> l2ping $TARGET_MAC
```

# Bluejack a Victim
Bluejack is a process of sending so-called "e-business" card (contains name, e-mail, phone number) to other devices via bluetooth. Bluejacking (from hacker prespective) works in the same way, means, that attacker can send malicious content instead of card infos. 
for this we need firstly pair/connect to victim device (victim has to accept to connect), then we can search on internet for many attacks can be done, like:
- sending e-business cards with malicious attachments
- pulling out confidential data out of the victim's device
- taking over the victim device and make calls, send messages, etc.. (ofcouse without the knowledge of the user)

Let's get to the point:
after attacker paired with victim's device, what next comes, depense of the used tool on the internet!

```
# Enable the bluetooth service locally
> service bluetooth start

# Enable the bluetooth interface 
> hciconfig $INTERFACE_NAME up

# show bluetooth interface configuration
> hciconfig $INTERFACE_NAME

# scan for bluetooth enabled devices (similar to airodump-ng from the 802.11 wireless word)
# With btscanner we can get (TARGET_MAC, OUR_MAC, TARGET_BLUETOOTH_NAME and other stuffs)
> btscanner
```

The main idea here, that TARGET_DEVICE is authenticated/paired with other devices, so attacker can spoof and 
-> set the attacker's mac address to the target mac address 
-> set attcker's bluetooth name to target bluetooth name, 
so to do that, we use the **spooftooth** (similar to macchanger, that we used to bypass MAC filtering/authentication in WEP senario)

Now we can communicate directly to other paired devices.

# Tools
**A Wireless Security Audit:** is a method of evaluating all Wi-Fi or Bluetooth Security aspects of networks by simulating attacks against authentication, encryption or becoming a MITM attacker. In other words, performing penetest on the network.
### Possible Audits (Tests)
-> Layer 1 Audit
-> Layer 2 Audit
-> WLAN Security Audit
-> Wired Infrastructure Audit
-> Social Engineering Audit
-> Wireless Intrusion Prevention System (WIPS) Audit

### Layer 1 and Layer 2 Audit
**The goal of a Layer 1 Audit**
to determine the RF coverage and find out about potential sources of RF interferences, for that we use a wifi spectrum analysis.
-> A WiFi spectrum analysis is **the process of measuring the WiFi signal in a certain area and determining its strength**. A WiFi spectrum analysis is typically performed to find/detect interference or intentionally put RF jammers that negatively impacts wireless performance (ex: speed lower, so it causes a layer 1 Dos attack) and to eliminate it. 

-> Wi-Fi interference is **any signal outside of the configured Wi-Fi network that impairs normal operation of the Wi-Fi network**. Typically, network operators will detect slower speeds, higher latency, frequent disconnects and reconnects, and sometimes a complete inability to connect to a Wi-Fi signal. 
Reference: https://www.hospitalitywifi.com/wifi-university/wifi-interference/

 **The goal of a Layer 2 Audit**
 to detect any rogue devices or unauthorized 802.11 devices. a Wireless IPS monitoring will detect such attacks and prevent it automatically.
 
 The Auditor/tester A list of points that the auditor should concentrate on, while performing layer 2 site survey is: MAC addresses, SSIDs, types of devices being used, types of traffic, channels that are in use, possible default configurations, possible layer 2 attacks taking place, ad-hoc clients, etc.
 
 -> Tools for the Auditor/tester for performing Layer 1,2 audit (test)
 -   Protocol sniffers/analyzers (ex. Wireshark)
-   2.4/5 GHz signal injectors.
-   Offensive tools (mdk3, Void11, Bugtraq, IKEcrack, FakeAP, etc.)

Tool Example:
**mdk3**. It is a proof-of-concept tool that allows for exploiting wireless network. It allows you:
-   Flood fake beacon tools (as a way to imitate a fake AP).
-   DoS of authentication frames (may lead to AP's freeze or restart if vulnerable).
-   Flood of disassociation/de-authentication frames (to kick out valid users out from the network).
-   802.1X wireless security testing.
-   Abusing Wireless Intrusion Prevention/Detection Systems (WIPS/WIDS) and bunch of other harmful things.
```
> ./mdk3 | more
# Creation of the Layer 2 DoS of de-authentication frames
> mdk3 $ATTACKER_INTERFACE_NAME d
# Many ways to do the same in Above, we can do that also with aireplay-ng
> aireplay-ng -deauth 0 -a $TARGET_AP_MAC $ATTACKER_INTERFACE_NAME

```

### WLAN Security Audit
 **The goal of WLAN Security Audit**
to investigate if and how a particular WLAN may be compromised (attacks on authentication and encryption, types of the deployed WLANs, weak keys in use and similar.)

-> Tools to perform WLAN Security Audit
-   Protocol sniffers/analyzers (ex. Wireshark).
-   Wireless discovery tools (ex. NetStumbler, Kismet, Win Sniffer, WiFiFoFum, etc.).
-   Encryption/Authentication breaking (testing) tools (aircrack-ng, custom scripts, all kinds of cryptoanalysis tools).

### Wired Infrastructure Audit
 **The goal of Wired Infrastructure Audit**
-   Inspection of the firewall used to restrict WLAN user access to certain network resources.
-   Switchport interfaces that are unused should be disabled.
-   A strong password should be used, and protocols with built-in encryption should be used (HTTPS, SSH), if possible.

### Social Engineering Audit
Non-technical approaches to get the information. like make employees trust you and get the WLAN password, or try to get the WPS PIN. 

Important to know, of what data should be kept private and what to be shared. In Enterprises, issueing security awareness campaigns to educate personnel

### Wireless Intrusion Prevention Systems
It used to perform deep packet inspection of the traversing packets, in order to look for anomalies, Trojans or other malicious pieces of code.
WIPS is for detecting and preventing the usage of unauthorized wireless devices.
The idea behind WIPS, is to have some APs (Another approach is to have a set of dedicated passive sensors) in your infrastructure dedicated configured in WIPS mode (do not broadcast any WLAN network or allow user to associate). Those AP's are preconfigured for a particular frequency channel and they just listen to the frequency spectrum all the time, looking for anomalies (flood of de-authentication frames, or flood of disassociation frames, detecting WLANs broadcasted by AP's with unknown BSSID, etc).

- one of WIPS solution is The Cisco Wireless solution and it is based on the Wireless LAN Controller (WLC) and set of APs



# Pentesting

# Wireless Penetration Testing
if you are located close enough, your wireless adapter is able to hear everything, that flowing over the air. 

2 phases to perform Wireless Penetesting:

1. Passive phase:
-> reconnaissance
-> Reading about the target security measures on internet, from the news 
-> Talking to legitimate users about security controls
-> Sniffing of the traffic

2. Active phase:
-> phishing e-mails
-> Injecting wireless frames (ex: de-authentication frames)
-> Creating fake AP, so that target user can connect to our Fake AP.

# Pentesting Unencrypted WLAN
Open Authentication - no password require to connect.
Lab:
We have a WLAN with SSID of "LAB-test" with open authentication.
Attacker do firstly passive scans, to detect all networks in the near. 

1. Attacker: enable his wireless card and create a WLAN monitoring interface, using airmon-ng utility
```
> ifconfig wlan0 up
> ifconfig wlan0
> airmon-ng start wlan0
> airmon-ng
```
2. Next detect/show all networks heard in the near
```
> airmon-ng mon0 (mon0 monitoring interface )
```
3. We can try to simulate if the wireless client would be able to connect to this SSID. We can make it using **aireplay-ng** utility.
```
> aireplay-ng --fakeauth 10 -e $TARGET_WLAN_NAME mon0
```

The only mechanism that you can use to improve a security of this unsecure environment is to implement MAC filtering.
```
> ifconfig mon0 down
> macchanger --mac=$ALLOWED_MAC_FILTERING mon0
> ifconfig mon0 up
> aireplay-ng --fakeauth 10 -e $TARGET_WLAN_NAME mon0
```

After implementing it, we try again the authentication process using aireplay-ng, and this time it fails.
```
> aireplay-ng --fakeauth 10 -e $TARGET_WLAN_NAME mon0
```

so in this case attacker need to spoof on of the allowed MAC addresses to get authenticate to the network.


# WEP Encrypted WLAN
WEP was the first wireless "secure" model, that had authentication and encryption added. It is based on RC4 algorithm and 24 bits of Initialization Vector (IV).

Lab:
We have a network Lab-test with implementing of WEP.
1. Attacker: enable his wireless card and create a WLAN monitoring interface, using airmon-ng utility
```
> ifconfig wlan0 up
> ifconfig wlan0
> airmon-ng start wlan0
> airmon-ng
```
2. Next detect/show all networks heard in the near
```
> airmon-ng mon0 (mon0 monitoring interface )
```
3. Attacker needs to collect data packets (around 25000 packets) exchanged over the air by this client, because as being said, data packets contain IV vector. so If we would collect enough data packets with IVs, we will finally get to the point where we have a set of weak IV vectors - it will allow us to derive the WEP password. For that we will use "airodump-ng" to sniff the wireless communication for particular BSSID (Lab-test). 
```
> 
```
4. After we collect the require packets, we can derive a key using "aircrack-ng"
```
> aircrack-ng crack_wep_lab-test.cap
```

As a result, we just collected passively data by sniffing over the air (with zero interaction with target network), and cracked the key with "aircrack-ng".

# Pentesting WPA/WPA2 Encrypted WLAN
WPA/WPA2 is the next evolution of secure wireless network that came up after WEP turned out to be insecure. The algorithms used by those protocols are much more secure (WPA: TKIP and WPA2: CCMP/AES), making it impossible to crack the network, using the same approach we did with WEP.

Breaking of WPA/WPA2 is based on the same idea – sniffing the initial 4-way handshake and applying brute-force attack in order to break encrypted password, so  the password has to be weak and not long in characters.

1. Attacker start with airodump-ng, to passively collect some information about the WLAN.
```
> airodump-ng --channel 1 mon0
```
2. enable sniffing of the traffic on (we don't care that much about data packets this time) target network is order to collect the initial 4-way handshake between AP and Wireless Client (any client in target network).
```
> airodump-ng --channel 1 mon0 --write wpa-crack
```
from now on, every time a new user joins the network, airodump is sniffing the 4-way handshake

2.extra-step: attack can perform a layer 2 dos attacker to de-authenticate all users, so they can connect again and attacker can sniff the 4-way handshake.

3. Now we are ready to crack the password. (with john, crunch, mimikat or aircrack-ng)
```
> crunch 8 8 abcdef0123456789 > dic.txt
```
4. now attacker use the any bruteforce tool to crack the password, attacker here will use "aircrack-ng"
```
> aircrack-ng wpa-handshake.cap -w dic.txt
```

Note: the longer the dictionary, the longer it will take to break the password


# Pentesting LEAP Encrypted WLAN
Lightweight Extensible Authentication Protocol (LEAP) is a Cisco-based legacy authentication protocol that uses external RADIUS server to authenticate users. It performs pseudo-mutual authentication of both wireless client and the authentication server, with the use of hashing functions - MS-CHAP and MS-CHAPv2.

### Vulnerability of LEAP
-   Username of the user is sent in clear-text – therefore the hacker only needs to get the password of the user, using, for example, social engineering.
-   The user's password is hacked with MS-CHAPv2 - algorithm is vulnerable to offline dictionary attack.
Lab:
1. attacker start with airodump-ng to find WLAN's are broadcasted in the environment.
Notice that the "AUTH" is **MGT**, which means that there is no static pre-shared key (PSK), but authentication services are moved to external authentication server (ex. RADIUS).
At that point, attacker do not know, what the particular WLAN network is based on LEAP, PEAP, EAP-TLS, EAP-TTLS or what other kind of EAP technology, so attacker can use **wireshark** to look into the packet in details.
2. Attacker open wireshark and filter for "eap" packets. Here attacker can see, authentication server was first trying to negotiate EAP-TTLS, but client refused. In the next 2 messages they have agreed to using LEAP. 
3. Attacker also found the username sent in clear text in one of those packets. In order to find out the password, we will have a look at **Request/Response** exchange.
4. At the bottom of the 802.1x Authentication header, you can observe that authentication server challenged the wireless client with a challenge text "197ad3e4c81227a4". Then in the background, wireless client has used a MS-CHAPv2 algorithm combined with LAB_user's password and got a hash of value "ef326a4844adb8288712a67e2dc659c4f9597dc4a7addc89", that was sent back to the authentication server. We know that MS-CHAPv2 is vulnerable to offline dictionary attacker (tool for breaking LEAP password, called **asleap**)
```
> asleap -r EAP_LEAP.PCAP -f asleap.dat -n aspleap.idx -s
```


Note: There is a big chance you will never see LEAP authentication in the production environment





